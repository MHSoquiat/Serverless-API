stages:
  - validate
  - plan
  - apply
  - notify

variables:
  TF_VERSION: "1.13.5"

before_script:
  - set -euo pipefail
  - apt-get update -y
  - apt-get install -y curl unzip python3 python3-venv
  - curl -L -o terraform.zip "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip"
  - unzip terraform.zip
  - mv terraform /usr/local/bin/
  - terraform --version

cache:
  paths:
    - .terraform/

# --- VALIDATE STAGE ---
validate:
  stage: validate
  script:
    - cd root
    - terraform init -backend=false
    - terraform fmt -check
    - terraform validate
  rules:
    - exists:
        - root/*.tf

# --- PLAN STAGE ---
plan:
  stage: plan
  script:
    - cd root
    - terraform init
    - terraform plan -out=tfplan
  artifacts:
    paths:
      - root/tfplan
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# --- APPLY STAGE ---
apply:
  stage: apply
  script:
    - cd root
    - terraform init
    - terraform apply -auto-approve tfplan
    - terraform output -raw api_endpoint > api_endpoint.txt
  artifacts:
    paths:
      - root/api_endpoint.txt
  dependencies:
    - plan
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual

# --- NOTIFY STAGE (SES EMAIL) ---
notify:
  stage: notify
  script:
    - cd root
    # create virtual environment
    - python3 -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install boto3
    # export API endpoint as env var
    - export API_ENDPOINT=$(cat api_endpoint.txt)
    # create SES email sender script
    - |
      cat <<'EOF' > send_email.py
      import boto3
      import os

      ses = boto3.client(
          "ses",
          region_name=os.environ["SES_REGION"],
          aws_access_key_id=os.environ["AWS_ACCESS_KEY_ID"],      # IAM access key
          aws_secret_access_key=os.environ["AWS_SECRET_ACCESS_KEY"]  # IAM secret
      )

      ses.send_email(
          Source=os.environ["SES_FROM_EMAIL"],
          Destination={"ToAddresses": [os.environ["SES_TO_EMAIL"]]},
          Message={
              "Subject": {"Data": "Terraform Deployment Complete"},
              "Body": {"Text": {"Data": f"Your API has been deployed.\nEndpoint: {os.environ['API_ENDPOINT']}"}}
          },
      )
      EOF
    # run SES email sender
    - python send_email.py
  dependencies:
    - apply
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
