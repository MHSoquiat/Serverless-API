stages:
  - validate
  - plan
  - apply

variables:
  TF_VERSION: "1.13.5"

before_script:
  - set -euo pipefail
  - apt-get update -y
  - apt-get install -y curl unzip
  - curl -L -o terraform.zip "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip"
  - unzip terraform.zip
  - mv terraform /usr/local/bin/
  - terraform --version

cache:
  paths:
    - .terraform/

# --- VALIDATION STAGE ---
validate:
  stage: validate
  script:
    - cd root
    - terraform init -backend=false
    - terraform fmt -check
    - terraform validate
  rules:
    - exists:
        - root/*.tf

# --- PLAN STAGE ---
plan:
  stage: plan
  script:
    - cd root
    - terraform init
    - terraform plan -out=tfplan
  artifacts:
    paths:
      - root/tfplan
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# --- APPLY STAGE ---
apply:
  stage: apply
  script:
    - cd root
    - terraform init
    - terraform apply -auto-approve tfplan
  dependencies:
    - plan
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
